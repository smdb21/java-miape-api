package org.proteored.miapeapi.xml.pride.util;

import org.proteored.miapeapi.cv.ms.SpectrumAttribute;
import org.proteored.miapeapi.xml.pride.autogenerated.CvParamType;
import org.proteored.miapeapi.xml.pride.autogenerated.Modification;
import org.proteored.miapeapi.xml.pride.autogenerated.ParamType;
import org.proteored.miapeapi.xml.pride.autogenerated.Peptide;

public class PridePSMIdentifier {
	public static String getPSMUniqueIdentifier(Peptide peptide) {
		StringBuilder sb = new StringBuilder();
		if (peptide.getSpectrumReference() != null) {
			sb.append(peptide.getSpectrumReference());
		} else {
			final String spectrumTitle = getSpectrumTitleFromAdditionalParams(peptide.getAdditional());
			if (spectrumTitle != null) {
				sb.append(spectrumTitle);
			}
		}
		// then, add the sequence with ptms
		sb.append(" " + peptide.getSequence());
		// ptms
		if (peptide.getModificationItem() != null) {
			for (Modification mod : peptide.getModificationItem()) {
				sb.append("pos:" + mod.getModLocation());
				if (mod.getModMonoDelta() != null) {
					sb.append("delta:" + mod.getModMonoDelta().get(0));
				}
			}
		}
		return sb.toString();
	}

	public static String getSpectrumTitleFromAdditionalParams(ParamType additionalParams) {
		final String spectrumTitleCVTermAccession = SpectrumAttribute.SPECTRUM_TITLE_ACC.getAccession();
		// try to get the spectrum title
		if (additionalParams != null) {
			if (additionalParams.getCvParamOrUserParam() != null) {
				for (Object cvParamOrUserParam : additionalParams.getCvParamOrUserParam()) {
					if (cvParamOrUserParam instanceof CvParamType) {
						CvParamType cvParam = (CvParamType) cvParamOrUserParam;

						if (cvParam.getAccession().equalsIgnoreCase(spectrumTitleCVTermAccession)) {
							return cvParam.getValue();
						}
					}
				}
			}
		}
		return null;
	}
}
