package org.proteored.miapeapi.xml.miapeproject;

import java.util.Date;

import org.proteored.miapeapi.exceptions.MiapeDatabaseException;
import org.proteored.miapeapi.exceptions.MiapeSecurityException;
import org.proteored.miapeapi.interfaces.MiapeDate;
import org.proteored.miapeapi.interfaces.Project;
import org.proteored.miapeapi.interfaces.User;
import org.proteored.miapeapi.interfaces.persistence.PersistenceManager;
import org.proteored.miapeapi.xml.miapeproject.autogenerated.MIAPEProject;

public class ProjectImpl implements Project {
	private final MIAPEProject xmlProject;
	private final User owner;
	private final PersistenceManager dbManager;
	private final int id = -1;
	private MiapeDate date;

	public ProjectImpl(MIAPEProject xmlProject, User owner, PersistenceManager dbManager) {
		this.xmlProject = xmlProject;
		this.owner = owner;
		this.dbManager = dbManager;

		if (xmlProject.getDate() != null)
			this.date = new MiapeDate(xmlProject.getDate());
	}

	public ProjectImpl(MIAPEProject projectXML, PersistenceManager dbManager, String userName, String password)
			throws MiapeDatabaseException, MiapeSecurityException {
		if (dbManager != null) {
			this.owner = dbManager.getUser(userName, password);
		} else {
			this.owner = null;
		}
		this.dbManager = dbManager;
		this.xmlProject = projectXML;

		if (xmlProject.getDate() != null)
			this.date = new MiapeDate(xmlProject.getDate());
	}

	@Override
	public String getComments() {
		return xmlProject.getComments();
	}

	@Override
	public MiapeDate getDate() {
		return this.date;
	}

	@Override
	public int getId() {
		if (xmlProject.getId() != null) {
			try {
				return Integer.valueOf(xmlProject.getId());
			} catch (Exception e) {
				// do nothing
			}
		}
		return id;
	}

	@Override
	public String getName() {
		return xmlProject.getName();
	}

	@Override
	public User getOwner() {
		return owner;
	}

	@Override
	public int store() throws MiapeDatabaseException, MiapeSecurityException {
		if (this.dbManager != null) {
			// check if the project has an owner
			if (this.getOwner() == null)
				throw new MiapeDatabaseException(
						"The project has to have an owner in order to store it in the database");
			// set project date to now
			this.setDate(new MiapeDate(new Date()));
			return dbManager.saveProject(this);
		}
		throw new MiapeDatabaseException("The persistance method is not defined.");
	}

	@Override
	public void delete(String userName, String password) throws MiapeDatabaseException, MiapeSecurityException {
		if (this.dbManager != null) {
			dbManager.deleteProjectById(this.getId(), userName, password);
			return;
		}
		throw new MiapeDatabaseException("The persistance method is not defined.");

	}

	private void setDate(MiapeDate date) {
		this.date = date;

	}
}
